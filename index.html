<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eligibility Checker</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      background-color: #f7f7f7;
    }

    .sidebar {
      flex: 0 0 300px;
      padding: 20px;
      background-color: #ffffff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .main-content {
      flex: 1;
      padding: 20px;
      overflow: auto;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1em;
    }

    .summary {
      margin-bottom: 20px;
      padding: 10px;
      background: #e6f0ff;
      border-left: 4px solid #3399ff;
    }

    .loader {
      display: none;
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 24px;
      height: 24px;
      animation: spin 2s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    .results-container {
      max-height: 70vh;
      overflow-y: auto;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        box-shadow: none;
      }

      .main-content {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="w-full max-w-xs space-y-4">
    <label class="block">
      <span class="block text-sm font-medium">Polytechnic</span>
      <select id="polytechnic" class="w-full border p-2 rounded">
        <option value="">Select Polytechnic</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm font-medium">Diploma</span>
      <select id="diploma" class="w-full border p-2 rounded">
        <option value="">Select Diploma</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm font-medium">College/Faculty</span>
      <select id="faculty" class="w-full border p-2 rounded">
        <option value="">Select Faculty</option>
      </select>
    </label>
    <label class="block">
      <span class="block text-sm font-medium">Programme</span>
      <select id="programme" class="w-full border p-2 rounded">
        <option value="">Select Programme</option>
      </select>
    </label>

    <div class="flex gap-2">
      <button id="checkBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Check Eligibility</button>
      <button id="resetBtn" class="bg-gray-400 text-white px-4 py-2 rounded">Reset</button>
    </div>

    <div class="loader hidden" id="loader"></div>
  </div>
</div>


<div class="main-content">
  <div class="summary" id="summaryText"></div>
  <div class="results-container">
    <table id="resultsTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Faculty</th>
          <th>Programme</th>
          <th>Requirements</th>
          <th>Website</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  const apiBase = "https://script.google.com/macros/s/AKfycby7XAr1IKH0R0HpoTkmv84ohigotdluUaq5e5arDQ2MdivdzvLJEU0Uo2JB7zRvk9Mk/exec";

  const polytechnicSelect = document.getElementById("polytechnic");
  const diplomaSelect = document.getElementById("diploma");
  const facultySelect = document.getElementById("faculty");
  const programmeSelect = document.getElementById("programme");
  const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
  const summaryText = document.getElementById("summaryText");
  const loader = document.getElementById("loader");

  function showLoader(show) {
    loader.style.display = show ? "block" : "none";
  }

  function populateSelect(selectElement, data, placeholder) {
    selectElement.innerHTML = `<option value="">Select ${placeholder}</option>`;
    data.forEach(item => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = item;
      selectElement.appendChild(opt);
    });
  }

  function resetDropdowns() {
    populateSelect(polytechnicSelect, [], "Polytechnic");
    populateSelect(diplomaSelect, [], "Diploma");
    populateSelect(facultySelect, [], "Faculty");
    populateSelect(programmeSelect, [], "Programme");
  }

  async function fetchData(action, params = {}) {
    const url = new URL(apiBase);
    url.searchParams.set("action", action);
    Object.entries(params).forEach(([key, val]) => url.searchParams.set(key, val));
    const res = await fetch(url);
    return await res.json();
  }

  async function initDropdowns() {
    try {
      const polys = await fetchData("getPolytechnic");
      populateSelect(polytechnicSelect, polys, "Polytechnic");

      const faculties = await fetchData("getFaculties");
      populateSelect(facultySelect, faculties, "Faculty");
    } catch (err) {
      console.error("Error initializing dropdowns:", err);
    }
  }

  polytechnicSelect.addEventListener("change", async () => {
    const selectedPoly = polytechnicSelect.value;

    if (selectedPoly) {
      const diplomas = await fetchData("getDiplomas", { polytechnic: selectedPoly });
      populateSelect(diplomaSelect, diplomas, "Diploma");
    } else {
      populateSelect(diplomaSelect, [], "Diploma");
    }

    populateSelect(programmeSelect, [], "Programme");
  });

  diplomaSelect.addEventListener("change", () => {
    populateSelect(programmeSelect, [], "Programme");
  });

  facultySelect.addEventListener("change", async () => {
    const selectedFaculty = facultySelect.value;

    if (selectedFaculty) {
      const programmes = await fetchData("getProgrammes", { faculty: selectedFaculty });
      populateSelect(programmeSelect, programmes, "Programme");
    } else {
      populateSelect(programmeSelect, [], "Programme");
    }
  });

  document.getElementById("checkBtn").addEventListener("click", async () => {
    const poly = polytechnicSelect.value;
    const dip = diplomaSelect.value;
    const fac = facultySelect.value;
    const prog = programmeSelect.value;

    if (!poly || !dip || !fac) {
      alert("Please select Polytechnic, Diploma, and Faculty.");
      return;
    }

    const params = {
      polytechnic: poly,
      diploma: dip,
      faculty: fac
    };
    if (prog) params.programme = prog;

    showLoader(true);
    try {
      const result = await fetchData("checkEligibility", params);

      resultsTable.innerHTML = "";
      if (result.length === 0) {
        resultsTable.innerHTML = `<tr><td colspan="5">No matching programmes found.</td></tr>`;
      } else {
        result.forEach((r, index) => {
          const row = resultsTable.insertRow();
          row.innerHTML = `
            <td>${r.No}</td>
            <td>${r.Faculty}</td>
            <td>${r.Programme}</td>
            <td>${r.Requirements}</td>
            <td><a href="${r.Website}" target="_blank">Link</a></td>
          `;
        });
      }

      summaryText.textContent = `Polytechnic: ${poly} | Diploma: ${dip} | Faculty: ${fac}` + (prog ? ` | Programme: ${prog}` : "");

      resetDropdowns();
      await initDropdowns();
    } catch (err) {
      console.error("Error checking eligibility:", err);
      alert("Error retrieving results.");
    }
    showLoader(false);
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    resultsTable.innerHTML = "";
    summaryText.textContent = "";
    resetDropdowns();
    initDropdowns();
  });

  window.onload = () => {
    initDropdowns();
  };
</script>
